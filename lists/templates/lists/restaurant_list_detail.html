{% extends 'base.html' %}

{% block title %}{{ restaurant_list.name }} - Munch{% endblock %}

{% block content %}
<h1>{{ restaurant_list.name }}</h1>

<div>
    <p><strong>Owner:</strong> {{ restaurant_list.owner.username }}</p>
    <p><strong>Created:</strong> {{ restaurant_list.inserted_at|date:"F j, Y" }}</p>
</div>

{% if user.is_authenticated and user == restaurant_list.owner %}
    <div style="margin: 20px 0;">
        <a href="{% url 'restaurantlistitem_create' restaurant_list.id %}">Add Restaurant to List</a> |
        <a href="{% url 'restaurantlist_edit' restaurant_list.id %}">Edit List</a>
    </div>
{% endif %}

{% if list_items %}
    <h2>Restaurants in this list</h2>
    
    {% if restaurant_coordinates %}
        <div id="map" style="height: 400px; width: 100%; margin: 20px 0; border: 1px solid #ccc;"></div>
        <script>
            // Initialize the map
            var map = L.map('map');
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add markers for all restaurants
            var restaurants = {{ restaurant_coordinates_json|safe }};
            var markers = [];
            
            restaurants.forEach(function(restaurant) {
                var marker = L.marker([restaurant.lat, restaurant.lng]).addTo(map);
                var popupContent = '<strong>' + restaurant.name + '</strong><br>' + restaurant.address;
                if (restaurant.notes) {
                    popupContent += '<br><em>Notes: ' + restaurant.notes + '</em>';
                }
                marker.bindPopup(popupContent);
                markers.push(marker);
            });
            
            // Fit map to show all markers
            if (markers.length > 0) {
                var group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        </script>
    {% endif %}
    
    <div>
        {% for item in list_items %}
            <div style="border: 1px solid #ccc; margin: 10px 0; padding: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <h3><a href="{% url 'restaurant_detail' item.restaurant.id %}">{{ item.restaurant.name }}</a></h3>
                        <p>{{ item.restaurant.address }}</p>
                        <p><strong>Added:</strong> {{ item.inserted_at|date:"F j, Y" }}</p>
                        {% if item.notes %}
                            <p><strong>Notes:</strong> {{ item.notes }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <p>No restaurants in this list yet. <a href="{% url 'restaurantlistitem_create' restaurant_list.id %}">Add one!</a></p>
{% endif %}

<div style="margin-top: 20px;">
    <a href="{% url 'restaurantlist_index' %}">Back to Lists</a>
</div>
{% endblock %}